<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©èªå–«èŒ¶ ç©ºå¸­æƒ…å ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
        /* èƒŒæ™¯è¨­å®šï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
        body {
            position: relative;
            background: linear-gradient(135deg, #8B4513 0%, #D2B48C 50%, #F5DEB3 100%);
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            font-family: 'Kosugi Maru', sans-serif;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(139, 69, 19, 0.1) 2px,
                rgba(139, 69, 19, 0.1) 4px
            ),
            repeating-linear-gradient(
                90deg,
                transparent,
                transparent 20px,
                rgba(160, 82, 45, 0.1) 20px,
                rgba(160, 82, 45, 0.1) 22px
            );
            pointer-events: none;
            z-index: -1;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
        }

        /* æ¥ç¶šçŠ¶æ…‹è¡¨ç¤º */
        .connection-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
            transition: all 0.3s;
            z-index: 10;
        }

        .status-connected {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .status-connecting {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }

        .status-disconnected {
            background: linear-gradient(45deg, #f44336, #da190b);
        }

        /* ã‚¿ã‚¤ãƒˆãƒ« */
        h1 {
            color: #8B4513;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            margin: 0 0 30px 0;
        }

        /* ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º */
        .staff-mode {
            background: linear-gradient(45deg, #ff6b6b, #ffa8a8);
            color: white;
            border: none;
            padding: 15px 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .customer-mode {
            background: linear-gradient(45deg, #51cf66, #8ce99a);
            color: white;
            border: none;
            padding: 15px 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(81, 207, 102, 0.3);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-display {
            font-size: 3em;
            font-weight: bold;
            margin: 40px 0;
            padding: 30px;
            border-radius: 15px;
            transition: all 0.5s ease;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
        }

        .status-free {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            color: #2e7d32;
            border-color: #4caf50;
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .status-taken {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            border-color: #f44336;
            box-shadow: 0 10px 25px rgba(244, 67, 54, 0.3);
        }

        .status-loading {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #7b1fa2;
            border-color: #9c27b0;
            animation: pulse 2s infinite;
        }

        .status-error {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #ef6c00;
            border-color: #ff9800;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
        .toggle-button {
            background: linear-gradient(45deg, #6a1b9a, #8e24aa);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(106, 27, 154, 0.4);
            margin: 20px 0;
            font-family: 'Kosugi Maru', sans-serif;
        }

        .toggle-button:hover:not(:disabled) {
            background: linear-gradient(45deg, #4a148c, #6a1b9a);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(106, 27, 154, 0.6);
        }

        .toggle-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .toggle-button:disabled {
            background: linear-gradient(45deg, #bdbdbd, #9e9e9e);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .error-message {
            color: #d32f2f;
            background: rgba(244, 67, 54, 0.1);
            border: 2px solid #ffcdd2;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 20px 0;
            font-weight: bold;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                margin: 0;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }

            .status-display {
                font-size: 2.2em;
                padding: 20px;
                margin: 30px 0;
            }

            .toggle-button {
                padding: 15px 30px;
                font-size: 1.1em;
            }

            .staff-mode, .customer-mode {
                padding: 12px 15px;
                margin-bottom: 20px;
                font-size: 14px;
            }

            .connection-status {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.6em;
            }

            .status-display {
                font-size: 1.8em;
                padding: 15px;
                margin: 20px 0;
            }

            .toggle-button {
                padding: 12px 25px;
                font-size: 1em;
            }
        }

        /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ã®èª¿æ•´ */
        @media (hover: none) and (pointer: coarse) {
            .toggle-button {
                min-height: 60px;
                min-width: 200px;
            }

            .toggle-button:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="connection-status" class="connection-status status-connecting">
            ğŸ”„ æ¥ç¶šä¸­...
        </div>
        
        <div id="mode-indicator"></div>
        
        <h1>ğŸª‘ ç‰©èªå–«èŒ¶ ç©ºå¸­çŠ¶æ³</h1>
        
        <div id="status" class="status-display status-loading">
            ğŸ“¡ èª­ã¿è¾¼ã¿ä¸­...
        </div>
        
        <button id="toggle" class="toggle-button" style="display: none;" disabled>
            ğŸ”„ ç©ºå¸­çŠ¶æ³ã‚’åˆ‡ã‚Šæ›¿ãˆ
        </button>
        
        <div id="error-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, enableNetwork } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
        const urlParams = new URLSearchParams(window.location.search);
        const isStaff = urlParams.get('mode') === 'staff';

        // åº—å“¡ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç°¡æ˜“ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
        if (isStaff) {
            const password = prompt("åº—å“¡ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
            if (password !== "takapan") {
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™");
                window.location.href = window.location.pathname;
            }
        }

        // DOMè¦ç´ ã®å–å¾—
        const status = document.getElementById("status");
        const toggle = document.getElementById("toggle");
        const connectionStatus = document.getElementById("connection-status");
        const errorContainer = document.getElementById("error-container");
        const modeIndicator = document.getElementById('mode-indicator');

        // ã‚¿ã‚¤ãƒˆãƒ«ã¨è¡¨ç¤ºã‚’å‹•çš„ã«å¤‰æ›´
        document.title = isStaff ? "ç‰©èªå–«èŒ¶ ç©ºå¸­æƒ…å ±ï¼ˆåº—å“¡ç”¨ï¼‰" : "ç‰©èªå–«èŒ¶ ç©ºå¸­æƒ…å ±";

        // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
        if (isStaff) {
            modeIndicator.innerHTML = '<div class="staff-mode"><strong>ğŸ”§ åº—å“¡ãƒ¢ãƒ¼ãƒ‰</strong> - ç©ºå¸­çŠ¶æ³ã®å¤‰æ›´ãŒå¯èƒ½ã§ã™</div>';
        } else {
            modeIndicator.innerHTML = '<div class="customer-mode"><strong>ğŸ‘¥ ãŠå®¢æ§˜ç”¨è¡¨ç¤º</strong> - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º</div>';
        }
        
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDX2rCP17YJAkepI03YL8c6kk-TchdH7bg",
            authDomain: "cafe-site-3132c.firebaseapp.com",
            projectId: "cafe-site-3132c",
            storageBucket: "cafe-site-3132c.firebasestorage.app",
            messagingSenderId: "864339715535",
            appId: "1:864339715535:web:c748a47790aff8b8cf1eba",
            measurementId: "G-85ZB35NQRT"
        };

        let app, db, seatRef, unsubscribe;
        let isConnected = false;
        let retryCount = 0;
        const maxRetries = 5;

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°
        function showError(message) {
            errorContainer.innerHTML = `<div class="error-message">âš ï¸ ${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        // æ¥ç¶šçŠ¶æ…‹æ›´æ–°
        function updateConnectionStatus(connected, message = '') {
            isConnected = connected;
            
            const statusMessages = {
                connecting: 'ğŸ”„ æ¥ç¶šä¸­...',
                connected: 'âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­',
                disconnected: 'âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼'
            };
            
            const statusType = connected ? 'connected' : (message ? 'disconnected' : 'connecting');
            
            connectionStatus.textContent = message || statusMessages[statusType];
            connectionStatus.className = `connection-status status-${statusType}`;
            
            if (isStaff) {
                toggle.disabled = !connected;
            }
        }

        // çŠ¶æ…‹æ›´æ–°é–¢æ•°
        function updateStatus(statusValue) {
            // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            status.className = 'status-display';
            
            if (statusValue === "free") {
                status.textContent = "ğŸŸ¢ ç©ºå¸­ã‚ã‚Š";
                status.classList.add('status-free');
            } else if (statusValue === "taken") {
                status.textContent = "ğŸ”´ ç©ºå¸­ãªã—";
                status.classList.add('status-taken');
            } else if (statusValue === null) {
                status.textContent = "â“ çŠ¶æ…‹ä¸æ˜";
                status.classList.add('status-error');
            } else {
                status.textContent = "ğŸ“¡ èª­ã¿è¾¼ã¿ä¸­...";
                status.classList.add('status-loading');
            }
        }

        // åˆæœŸåŒ–ã¨ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
        async function initializeFirebase() {
            try {
                console.log(`FirebaseåˆæœŸåŒ–è©¦è¡Œ ${retryCount + 1}/${maxRetries + 1}`);
                updateConnectionStatus(false, 'ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­...');
                
                // FirebaseåˆæœŸåŒ–
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                seatRef = doc(db, "reservation", "seat");

                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æœ‰åŠ¹åŒ–
                await enableNetwork(db);
                
                // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')), 10000)
                );
                
                const dataPromise = getDoc(seatRef);
                const docSnap = await Promise.race([dataPromise, timeoutPromise]);
                
                if (docSnap.exists()) {
                    updateStatus(docSnap.data().status);
                    updateConnectionStatus(true);
                    console.log("åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ");
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã‚’è¨­å®š
                    console.log("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã‚’è¨­å®š");
                    await setDoc(seatRef, { status: "free" });
                    updateStatus("free");
                    updateConnectionStatus(true);
                }

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–è¨­å®š
                unsubscribe = onSnapshot(seatRef, (docSnap) => {
                    try {
                        if (docSnap.exists()) {
                            const statusValue = docSnap.data().status;
                            updateStatus(statusValue);
                            updateConnectionStatus(true);
                            retryCount = 0; // æˆåŠŸã—ãŸã‚‰ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
                        } else {
                            console.warn("ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“");
                            updateStatus(null);
                        }
                    } catch (error) {
                        console.error("ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
                        showError("ãƒ‡ãƒ¼ã‚¿æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                    }
                }, (error) => {
                    console.error("ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:", error);
                    updateConnectionStatus(false, 'æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
                    showError("æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†è©¦è¡Œä¸­...");
                    
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•å†æ¥ç¶š
                    if (retryCount < maxRetries) {
                        setTimeout(initializeFirebase, Math.pow(2, retryCount) * 1000);
                    } else {
                        showError("æ¥ç¶šã®å¾©æ—§ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
                    }
                });

                // ã‚¹ã‚¿ãƒƒãƒ•ç”¨ãƒœã‚¿ãƒ³è¨­å®š
                if (isStaff) {
                    toggle.style.display = 'inline-block';
                    toggle.addEventListener("click", handleToggleClick);
                }

            } catch (error) {
                console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
                updateConnectionStatus(false, 'Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼');
                
                retryCount++;
                if (retryCount <= maxRetries) {
                    showError(`æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚${Math.pow(2, retryCount)}ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™...`);
                    setTimeout(initializeFirebase, Math.pow(2, retryCount) * 1000);
                } else {
                    showError("æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
                    updateStatus("error");
                }
            }
        }

        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        async function handleToggleClick() {
            if (!isConnected) {
                showError("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“");
                return;
            }

            toggle.disabled = true;
            
            try {
                const docSnap = await getDoc(seatRef);
                if (docSnap.exists()) {
                    const currentStatus = docSnap.data().status;
                    const newStatus = currentStatus === "free" ? "taken" : "free";
                    await setDoc(seatRef, { status: newStatus });
                    console.log(`çŠ¶æ…‹ã‚’ ${currentStatus} ã‹ã‚‰ ${newStatus} ã«å¤‰æ›´`);
                } else {
                    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
                    await setDoc(seatRef, { status: "free" });
                    console.log("æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ");
                }
            } catch (error) {
                console.error("çŠ¶æ…‹å¤‰æ›´ã‚¨ãƒ©ãƒ¼:", error);
                showError("çŠ¶æ…‹ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ");
            } finally {
                if (isConnected) {
                    toggle.disabled = false;
                }
            }
        }

        // æ¥ç¶šçŠ¶æ…‹ç›£è¦–
        window.addEventListener('online', () => {
            console.log("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¾©æ—§");
            if (!isConnected && retryCount <= maxRetries) {
                retryCount = 0;
                initializeFirebase();
            }
        });

        window.addEventListener('offline', () => {
            console.log("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­");
            updateConnectionStatus(false, 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãªã—');
            showError("ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        // åˆæœŸåŒ–é–‹å§‹
        initializeFirebase();
    </script>
</body>

</html>
