<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物語喫茶 空席情報</title>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
        /* 背景設定（グラデーション） */
        body {
            position: relative;
            background: linear-gradient(135deg, #8B4513 0%, #D2B48C 50%, #F5DEB3 100%);
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            font-family: 'Kosugi Maru', sans-serif;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(139, 69, 19, 0.1) 2px,
                rgba(139, 69, 19, 0.1) 4px
            ),
            repeating-linear-gradient(
                90deg,
                transparent,
                transparent 20px,
                rgba(160, 82, 45, 0.1) 20px,
                rgba(160, 82, 45, 0.1) 22px
            );
            pointer-events: none;
            z-index: -1;
        }

        /* メインコンテナ */
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
        }

        /* 接続状態表示 */
        .connection-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
            transition: all 0.3s;
            z-index: 10;
        }

        .status-connected {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .status-connecting {
            background: linear-gradient(45deg, #FF9800, #F57C00);
        }

        .status-disconnected {
            background: linear-gradient(45deg, #f44336, #da190b);
        }

        /* タイトル */
        h1 {
            color: #8B4513;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            margin: 0 0 30px 0;
        }

        /* モード表示 */
        .staff-mode {
            background: linear-gradient(45deg, #ff6b6b, #ffa8a8);
            color: white;
            border: none;
            padding: 15px 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .customer-mode {
            background: linear-gradient(45deg, #51cf66, #8ce99a);
            color: white;
            border: none;
            padding: 15px 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(81, 207, 102, 0.3);
        }

        /* ステータス表示 */
        .status-display {
            font-size: 3em;
            font-weight: bold;
            margin: 40px 0;
            padding: 30px;
            border-radius: 15px;
            transition: all 0.5s ease;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
        }

        .status-free {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            color: #2e7d32;
            border-color: #4caf50;
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .status-taken {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            border-color: #f44336;
            box-shadow: 0 10px 25px rgba(244, 67, 54, 0.3);
        }

        .status-loading {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #7b1fa2;
            border-color: #9c27b0;
            animation: pulse 2s infinite;
        }

        .status-error {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #ef6c00;
            border-color: #ff9800;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* 切り替えボタン */
        .toggle-button {
            background: linear-gradient(45deg, #6a1b9a, #8e24aa);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(106, 27, 154, 0.4);
            margin: 20px 0;
            font-family: 'Kosugi Maru', sans-serif;
        }

        .toggle-button:hover:not(:disabled) {
            background: linear-gradient(45deg, #4a148c, #6a1b9a);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(106, 27, 154, 0.6);
        }

        .toggle-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .toggle-button:disabled {
            background: linear-gradient(45deg, #bdbdbd, #9e9e9e);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* エラーメッセージ */
        .error-message {
            color: #d32f2f;
            background: rgba(244, 67, 54, 0.1);
            border: 2px solid #ffcdd2;
            border-radius: 10px;
            padding: 15px 20px;
            margin: 20px 0;
            font-weight: bold;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
                margin: 0;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 20px;
            }

            .status-display {
                font-size: 2.2em;
                padding: 20px;
                margin: 30px 0;
            }

            .toggle-button {
                padding: 15px 30px;
                font-size: 1.1em;
            }

            .staff-mode, .customer-mode {
                padding: 12px 15px;
                margin-bottom: 20px;
                font-size: 14px;
            }

            .connection-status {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.6em;
            }

            .status-display {
                font-size: 1.8em;
                padding: 15px;
                margin: 20px 0;
            }

            .toggle-button {
                padding: 12px 25px;
                font-size: 1em;
            }
        }

        /* タッチデバイス用の調整 */
        @media (hover: none) and (pointer: coarse) {
            .toggle-button {
                min-height: 60px;
                min-width: 200px;
            }

            .toggle-button:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="connection-status" class="connection-status status-connecting">
            🔄 接続中...
        </div>
        
        <div id="mode-indicator"></div>
        
        <h1>🪑 物語喫茶 空席状況</h1>
        
        <div id="status" class="status-display status-loading">
            📡 読み込み中...
        </div>
        
        <button id="toggle" class="toggle-button" style="display: none;" disabled>
            🔄 空席状況を切り替え
        </button>
        
        <div id="error-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, enableNetwork } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        
        // URLパラメータをチェック
        const urlParams = new URLSearchParams(window.location.search);
        const isStaff = urlParams.get('mode') === 'staff';

        // 店員モードの場合、簡易パスワードチェック
        if (isStaff) {
            const password = prompt("店員用パスワードを入力してください:");
            if (password !== "takapan") {
                alert("パスワードが間違っています");
                window.location.href = window.location.pathname;
            }
        }

        // DOM要素の取得
        const status = document.getElementById("status");
        const toggle = document.getElementById("toggle");
        const connectionStatus = document.getElementById("connection-status");
        const errorContainer = document.getElementById("error-container");
        const modeIndicator = document.getElementById('mode-indicator');

        // タイトルと表示を動的に変更
        document.title = isStaff ? "物語喫茶 空席情報（店員用）" : "物語喫茶 空席情報";

        // モード表示
        if (isStaff) {
            modeIndicator.innerHTML = '<div class="staff-mode"><strong>🔧 店員モード</strong> - 空席状況の変更が可能です</div>';
        } else {
            modeIndicator.innerHTML = '<div class="customer-mode"><strong>👥 お客様用表示</strong> - リアルタイム表示</div>';
        }
        
        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyDX2rCP17YJAkepI03YL8c6kk-TchdH7bg",
            authDomain: "cafe-site-3132c.firebaseapp.com",
            projectId: "cafe-site-3132c",
            storageBucket: "cafe-site-3132c.firebasestorage.app",
            messagingSenderId: "864339715535",
            appId: "1:864339715535:web:c748a47790aff8b8cf1eba",
            measurementId: "G-85ZB35NQRT"
        };

        let app, db, seatRef, unsubscribe;
        let isConnected = false;
        let retryCount = 0;
        const maxRetries = 5;

        // エラー表示関数
        function showError(message) {
            errorContainer.innerHTML = `<div class="error-message">⚠️ ${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        // 接続状態更新
        function updateConnectionStatus(connected, message = '') {
            isConnected = connected;
            
            const statusMessages = {
                connecting: '🔄 接続中...',
                connected: '✅ リアルタイム同期中',
                disconnected: '❌ 接続エラー'
            };
            
            const statusType = connected ? 'connected' : (message ? 'disconnected' : 'connecting');
            
            connectionStatus.textContent = message || statusMessages[statusType];
            connectionStatus.className = `connection-status status-${statusType}`;
            
            if (isStaff) {
                toggle.disabled = !connected;
            }
        }

        // 状態更新関数
        function updateStatus(statusValue) {
            // クラスをリセット
            status.className = 'status-display';
            
            if (statusValue === "free") {
                status.textContent = "🟢 空席あり";
                status.classList.add('status-free');
            } else if (statusValue === "taken") {
                status.textContent = "🔴 空席なし";
                status.classList.add('status-taken');
            } else if (statusValue === null) {
                status.textContent = "❓ 状態不明";
                status.classList.add('status-error');
            } else {
                status.textContent = "📡 読み込み中...";
                status.classList.add('status-loading');
            }
        }

        // 初期化とリトライ機能
        async function initializeFirebase() {
            try {
                console.log(`Firebase初期化試行 ${retryCount + 1}/${maxRetries + 1}`);
                updateConnectionStatus(false, '🔄 データベースに接続中...');
                
                // Firebase初期化
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                seatRef = doc(db, "reservation", "seat");

                // ネットワーク有効化
                await enableNetwork(db);
                
                // 初期データ読み込み（タイムアウト付き）
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('初期データ読み込みタイムアウト')), 10000)
                );
                
                const dataPromise = getDoc(seatRef);
                const docSnap = await Promise.race([dataPromise, timeoutPromise]);
                
                if (docSnap.exists()) {
                    updateStatus(docSnap.data().status);
                    updateConnectionStatus(true);
                    console.log("初期データ読み込み成功");
                } else {
                    // デフォルト状態を設定
                    console.log("ドキュメントが存在しないため、デフォルト状態を設定");
                    await setDoc(seatRef, { status: "free" });
                    updateStatus("free");
                    updateConnectionStatus(true);
                }

                // リアルタイム監視設定
                unsubscribe = onSnapshot(seatRef, (docSnap) => {
                    try {
                        if (docSnap.exists()) {
                            const statusValue = docSnap.data().status;
                            updateStatus(statusValue);
                            updateConnectionStatus(true);
                            retryCount = 0; // 成功したらリトライカウントリセット
                        } else {
                            console.warn("ドキュメントが存在しません");
                            updateStatus(null);
                        }
                    } catch (error) {
                        console.error("リアルタイム更新エラー:", error);
                        showError("データ更新中にエラーが発生しました");
                    }
                }, (error) => {
                    console.error("リスナーエラー:", error);
                    updateConnectionStatus(false, '接続が切断されました');
                    showError("接続が切断されました。再試行中...");
                    
                    // エラー時の自動再接続
                    if (retryCount < maxRetries) {
                        setTimeout(initializeFirebase, Math.pow(2, retryCount) * 1000);
                    } else {
                        showError("接続の復旧に失敗しました。ページを再読み込みしてください。");
                    }
                });

                // スタッフ用ボタン設定
                if (isStaff) {
                    toggle.style.display = 'inline-block';
                    toggle.addEventListener("click", handleToggleClick);
                }

            } catch (error) {
                console.error("Firebase初期化エラー:", error);
                updateConnectionStatus(false, 'Firebase接続エラー');
                
                retryCount++;
                if (retryCount <= maxRetries) {
                    showError(`接続エラー。${Math.pow(2, retryCount)}秒後に再試行します...`);
                    setTimeout(initializeFirebase, Math.pow(2, retryCount) * 1000);
                } else {
                    showError("接続に失敗しました。インターネット接続を確認してページを再読み込みしてください。");
                    updateStatus("error");
                }
            }
        }

        // ボタンクリック処理
        async function handleToggleClick() {
            if (!isConnected) {
                showError("データベースに接続されていません");
                return;
            }

            toggle.disabled = true;
            
            try {
                const docSnap = await getDoc(seatRef);
                if (docSnap.exists()) {
                    const currentStatus = docSnap.data().status;
                    const newStatus = currentStatus === "free" ? "taken" : "free";
                    await setDoc(seatRef, { status: newStatus });
                    console.log(`状態を ${currentStatus} から ${newStatus} に変更`);
                } else {
                    // ドキュメントが存在しない場合は作成
                    await setDoc(seatRef, { status: "free" });
                    console.log("新しいドキュメントを作成");
                }
            } catch (error) {
                console.error("状態変更エラー:", error);
                showError("状態の変更に失敗しました");
            } finally {
                if (isConnected) {
                    toggle.disabled = false;
                }
            }
        }

        // 接続状態監視
        window.addEventListener('online', () => {
            console.log("ネットワーク復旧");
            if (!isConnected && retryCount <= maxRetries) {
                retryCount = 0;
                initializeFirebase();
            }
        });

        window.addEventListener('offline', () => {
            console.log("ネットワーク切断");
            updateConnectionStatus(false, 'インターネット接続なし');
            showError("インターネット接続が切断されました");
        });

        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        // 初期化開始
        initializeFirebase();
    </script>
</body>

</html>
